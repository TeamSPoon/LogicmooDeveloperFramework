<IfModule mod_ssl.c>
<VirtualHost *:443>
	# The ServerName directive sets the request scheme, hostname and port that
	# the server uses to identify itself. This is used when creating
	# redirection URLs. In the context of virtual hosts, the ServerName
	# specifies what hostname must appear in the request's Host: header to
	# match this virtual host. For the default virtual host (this file) this
	# value is not decisive as it is used as a last resort host regardless.
	# However, you must set it for any further virtual host explicitly.

	ServerAdmin logicmoo@gmail.com
	ServerName logicmoo.org
	DocumentRoot /var/www/html

	# Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
	# error, crit, alert, emerg.
	# It is also possible to configure the loglevel for particular
	# modules, e.g.
	#LogLevel info ssl:warn

	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

	# DirectoryIndex index.html index.htm index.php welcome.html
     

   SSLCertificateFile /etc/letsencrypt/live/logicmoo.org/fullchain.pem   
   SSLCertificateKeyFile /etc/letsencrypt/live/logicmoo.org/privkey.pem
   Include /etc/letsencrypt/options-ssl-apache.conf
   

Header always set X-Frame-Options "SAMEORIGIN"
SetEnvIf Referer "^(http:\/\/.*logicmoo\.org)/.*" X_FRAME_OPTIONS_ALLOWED=$1
SetEnvIf Referer "^(https:\/\/.*logicmoo\.org)/.*" X_FRAME_OPTIONS_ALLOWED=$1

Header set X-Frame-Options SAMEORIGIN
#Header append X-Frame-Options "ALLOW-FROM %{X_FRAME_OPTIONS_ALLOWED}e" env=X_FRAME_OPTIONS_ALLOWED`

RewriteEngine On
ProxyPreserveHost On

<Directory />
    Options +Indexes
    AllowOverride All
    #Options +FollowSymLinks +Includes +Indexes
    #IndexOptions +FancyIndexing
    # Options SymLinksIfOwnerMatch 
    Order allow,deny
    Allow from all
    Require all granted
</Directory>


# Ensure that encoded slashes are not decoded but left in their encoded state.                                                                                                                                                                                                    
# http://doc.gitlab.com/ce/api/projects.html#get-single-project                                                                                                                                                                                                                   
AllowEncodedSlashes NoDecode

# This will enable the Rewrite capabilities                                                                                                                                                                                                                                       
#RewriteCond %{HTTPS} !=on
# This checks to make sure the connection is not already HTTPS                                                                                                                                                                                                                    
#RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
                                                                                                                                                                                            
# RequestHeader set X-Forwarded-Proto "https"
# RequestHeader set X-Forwarded-Ssl on

#RewriteCond %{HTTP_REFERER} ^https\:\/\/logicmoo\.org\/port3100.* [NC]
RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
RewriteRule .* ws://localhost:3100%{REQUEST_URI} [P]

RewriteCond %{HTTP_REFERER} ^https\:\/\/logicmoo\.org\/port3100.* [NC]
RewriteRule "^/(.*)" "http://localhost:3100/$1" [P,L]

ProxyPass /port3100 http://logicmoo.org:3100
ProxyPassReverse /port3100 http://logicmoo.org:3100
ProxyPass /static/ http://logicmoo.org:3100/static/
ProxyPassReverse /static/ http://logicmoo.org:3100/static/

#RewriteCond %{HTTP_REFERER} ^https\:\/\/logicmoo\.org\/port3904.* [NC]
#RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
#RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
#RewriteRule .* ws://localhost:3904%{REQUEST_URI} [P]

ProxyPass /port3904 http://logicmoo.org:3904
ProxyPassReverse /port3904 http://logicmoo.org:3904


ProxyPass /gitlab/ http://logicmoo.org:1080/gitlab/                          
ProxyPassReverse /gitlab http://logicmoo.org:1080/gitlab

Include /etc/apache2/conf-available/cliopatria_swish.conf



#ProxyPass /wordpress/ https://logicmoo.org:1800/
#ProxyPassReverse /wordpress/ https://logicmoo.org:1800/

#ProxyPassReverse "/" "http://logicmoo.org:5005/"
#ProxyPassReverse "/" "https://logicmoo.org:5005/"

RewriteCond %{REQUEST_URI} !^/$
RewriteCond %{REQUEST_URI} !^/index.*
RewriteCond %{REQUEST_URI} !^/old-index.*
RewriteCond %{REQUEST_URI} !^/favicon.*
RewriteCond %{REQUEST_URI} !^/assets/.*
RewriteCond %{REQUEST_URI} !^/vendor/.*
RewriteCond %{REQUEST_URI} !^/wordpress.*
RewriteCond %{REQUEST_URI} !^/privacy.html
RewriteCond %{REQUEST_URI} !^/gitlab.*
RewriteCond %{REQUEST_URI} !^/wiki.*
RewriteCond %{REQUEST_URI} !^/port.*
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-l
RewriteRule "^/(.*)" "http://localhost:4080/$1" [P,L]
# RewriteRule .? /index.php?url=%{REQUEST_URI} [L,QSA]

# ProxyPassReverse "/" "http://www.swi-prolog.org"
# ProxyPassReverse "/" "https://edu.swi-prolog.org"
# ProxyPassReverse "/" "http://logicmoo.org:4080"



</VirtualHost>
</IfModule>




Listen 13904 
<VirtualHost *:13904>
ServerAdmin logicmoo@gmail.com
ServerName logicmoo.org
DocumentRoot /var/www/html
ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
SSLCertificateFile /etc/letsencrypt/live/logicmoo.org/fullchain.pem   
SSLCertificateKeyFile /etc/letsencrypt/live/logicmoo.org/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
RewriteEngine On
ProxyPreserveHost On
RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
RewriteRule .* ws://localhost:3904%{REQUEST_URI} [P,L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule "^/(.*)" "http://localhost:3904/$1" [P,L]
</VirtualHost>


Listen 13100 
<VirtualHost *:13100>
ServerAdmin logicmoo@gmail.com
ServerName logicmoo.org
DocumentRoot /var/www/html
ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
SSLCertificateFile /etc/letsencrypt/live/logicmoo.org/fullchain.pem   
SSLCertificateKeyFile /etc/letsencrypt/live/logicmoo.org/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
RewriteEngine On
ProxyPreserveHost On
RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
RewriteRule .* ws://localhost:3100%{REQUEST_URI} [P,L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule "^/(.*)" "http://localhost:3100/$1" [P,L]
</VirtualHost>

Listen 13101 
<VirtualHost *:13101>
ServerAdmin logicmoo@gmail.com
ServerName logicmoo.org
DocumentRoot /var/www/html
ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
SSLCertificateFile /etc/letsencrypt/live/logicmoo.org/fullchain.pem   
SSLCertificateKeyFile /etc/letsencrypt/live/logicmoo.org/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
RewriteEngine On
ProxyPreserveHost On
RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
RewriteRule .* ws://localhost:3101%{REQUEST_URI} [P,L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule "^/(.*)" "http://localhost:3101/$1" [P,L]
</VirtualHost>

Listen 8181 
<VirtualHost *:8181>
ServerAdmin logicmoo@gmail.com
ServerName logicmoo.org
DocumentRoot /var/www/html
ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
SSLCertificateFile /etc/letsencrypt/live/logicmoo.org/fullchain.pem   
SSLCertificateKeyFile /etc/letsencrypt/live/logicmoo.org/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
RewriteEngine On
ProxyPreserveHost On
RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
RewriteRule .* ws://localhost:8282%{REQUEST_URI} [P,L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule "^/(.*)" "http://localhost:8282/$1" [P,L]
</VirtualHost>

Listen 13123 
<VirtualHost *:13123>
ServerAdmin logicmoo@gmail.com
ServerName logicmoo.org
DocumentRoot /var/www/html
ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
SSLCertificateFile /etc/letsencrypt/live/logicmoo.org/fullchain.pem   
SSLCertificateKeyFile /etc/letsencrypt/live/logicmoo.org/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
RewriteEngine On
ProxyPreserveHost On
RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
RewriteRule .* ws://localhost:3123%{REQUEST_URI} [P,L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule "^/(.*)" "http://localhost:3123/$1" [P,L]
</VirtualHost>


Listen 13103 
<VirtualHost *:13103>
ServerAdmin logicmoo@gmail.com
ServerName logicmoo.org
DocumentRoot /var/www/html
ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
SSLCertificateFile /etc/letsencrypt/live/logicmoo.org/fullchain.pem   
SSLCertificateKeyFile /etc/letsencrypt/live/logicmoo.org/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
RewriteEngine On
ProxyPreserveHost On
RewriteCond %{HTTP:UPGRADE} ^WebSocket$   [NC]
RewriteCond %{HTTP:CONNECTION} ^Upgrade$ [NC]
RewriteRule .* ws://localhost:3103%{REQUEST_URI} [P,L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule "^/(.*)" "http://localhost:3103/$1" [P,L]
</VirtualHost>



