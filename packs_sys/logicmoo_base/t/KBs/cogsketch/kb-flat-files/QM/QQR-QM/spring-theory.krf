;;;; -*-  Mode: LISP; Syntax: Common-Lisp; Base: 10                          -*-
;;;; ---------------------------------------------------------------------------
;;;; File name: spring-theory.meld
;;;;    System: CogSketch
;;;;    Author: Jon Wetzel
;;;;   Created: February 12, 2014 17:00:21
;;;;   Purpose: QP domain theory for springs
;;;; ---------------------------------------------------------------------------
;;;;  $LastChangedDate: 2018-09-22 12:28:27 -0500 (Sat, 22 Sep 2018) $
;;;;  $LastChangedBy: hinrichs $
;;;; ---------------------------------------------------------------------------

(in-microtheory SpringTheoryMt)

(isa SpringTheoryMt Microtheory)
(genlMt SpringTheoryMt QPTheoryMt)
(genlMt SpringTheoryMt CompositionalModelingMt)
(genlMt ConceptualPhysicsDomainTheoryCollectorMt SpringTheoryMt)

;; requires 2d-mechanics-theory.meld
(genlMt SpringTheoryMt 2D-MechanicsTheoryMt)


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; Inclusion
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(<== (includeEntity ?x)
     (wmOnly (isa ?x Spring-Device)))

(<== (hasQuantity ?x (2DNetForceFn ?x)) ;; all springs get a netForceMag
     (wmOnly (isa ?x Spring-Device)))

(isa LengthFn Function-Denotational)
(comment LengthFn "(LengthFn ?x) refers to the length of ?x.")
;; If needed, we can move this up to 2D-MechanicsTheoryMt or rename it
;; SpringLengthFn.
(arity LengthFn 1)
(arg1Isa LengthFn Spring-Device)
(resultIsa LengthFn Distance)
(<== (hasQuantity ?obj (LengthFn ?obj))
     (wmOnly (isa ?obj Spring-Device)))

(isa RestLengthFn Function-Denotational)
(comment RestLengthFn "(RestLengthFn ?s) refers to the resting length of ?s.")
(arity RestLengthFn 1)
(arg1Isa RestLengthFn Spring-Device)
(resultIsa RestLengthFn Distance)
(<== (hasQuantity ?obj (RestLengthFn ?obj))
     (wmOnly (isa ?obj Spring-Device)))

(isa SpringKFn Function-Denotational)
(comment SpringKFn "(SpringKFn ?s) refers to the spring constant, k, of ?s.")
(arity SpringKFn 1)
(arg1Isa SpringKFn Spring-Device)
(resultIsa SpringKFn Number)
(<== (hasQuantity ?obj (SpringKFn ?obj))
     (wmOnly (isa ?obj Spring-Device)))

(isa SpringForceFn Function-Denotational)
(comment SpringForceFn "(SpringForceFn ?s) refers to the amount of force
                        generated by the spring ?s.")
(arity SpringForceFn 1)
(arg1Isa SpringForceFn Spring-Device)
(resultIsa SpringForceFn Number)
(<== (hasQuantity ?obj (SpringForceFn ?obj))
     (wmOnly (isa ?obj Spring-Device)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; Model Fragments
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; SpringForce
(isa SpringForce Collection)
(isa SpringForce PhysicalModelFragmentType)
(mfTypeParticipant SpringForce ?spring Spring-Device springOf)

(mfTypeConsequence SpringForce (qprop- 
                                (SpringForceFn ?spring ?axis)
                                (LengthFn ?spring)))
(mfTypeConsequence SpringForce (qprop
                                (SpringForceFn ?spring ?axis)
                                (SpringKFn ?spring)))
(mfTypeConsequence SpringForce (qpCorrespondence
                                (SpringForceFn ?spring ?axis) 
                                (LengthFn ?spring)
                                Zero (RestLengthFn ?spring)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; Spring block connection
(isa SpringConnection Collection)
(isa SpringConnection PhysicalModelFragmentType)
(mfTypeParticipant SpringConnection ?spring Spring-Device springOf)
(mfTypeParticipant SpringConnection ?obj Physob objectOf)
(mfTypeParticipant SpringConnection ?sfa ForceApplied mfParticipant)
(mfTypeParticipant SpringConnection ?axis QVAxis axisOf)

(mfTypeParticipantConstraint SpringConnection (forceSourceOf ?sfa ?spring))
(mfTypeParticipantConstraint SpringConnection (objectOf ?sfa ?obj))
(mfTypeParticipantConstraint SpringConnection (different ?obj ?spring))
(mfTypeParticipantConstraint SpringConnection 
                             (and (forceAppliedToObj ?obj ?dir ?spring)
                                  (qvAxisAligned ?dir ?axis)))

;; note: only works with springs connected to objects
(mfTypeCondition SpringConnection (connectedTo-Directly ?spring ?block))

;; consequences
(mfTypeConsequence SpringConnection (q= (ForceAppliedFn ?obj ?spring) 
                                        (SpringForceFn ?spring)))
(mfTypeConsequence SpringConnection (qprop (ForceAppliedFn ?obj ?spring)
                                           (SpringForceFn ?spring)))
(mfTypeConsequence SpringConnection (qprop (LengthFn ?spring)
                                           (PositionFn ?obj ?axis)))
;; this last one fixes where 0 is for the object!!
(mfTypeConsequence SpringConnection (qpCorrespondence
                                     (LengthFn ?spring) 
                                     (PostionFn ?obj ?axis)
                                     (RestLengthFn ?spring) Zero))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; Spring States

;;; SpringCompressed
(isa CompressedSpring Collection)
(isa CompressedSpring PhysicalModelFragmentType)
(mfTypeParticipant CompressedSpring ?spring Spring-Device springOf)
(mfTypeParticipantConstraint CompressedSpring (hasQuantity 
                                               ?spring (LengthFn ?spring)))
(mfTypeParticipantConstraint CompressedSpring (hasQuantity 
                                               ?spring (RestLengthFn ?spring)))
(mfTypeCondition CompressedSpring (qLessThan (LengthFn ?spring)
                                             (RestLengthFn ?spring)))

;;; SpringRest
(isa RestingSpring Collection)
(isa RestingSpring PhysicalModelFragmentType)
(mfTypeParticipant RestingSpring ?spring Spring-Device springOf)
(mfTypeParticipantConstraint RestingSpring (hasQuantity 
                                         ?spring (LengthFn ?spring)))
(mfTypeParticipantConstraint RestingSpring (hasQuantity 
                                         ?spring (RestLengthFn ?spring)))
(mfTypeCondition RestingSpring (q= (LengthFn ?spring) (RestLengthFn ?spring)))

;;; SpringStretched
(isa StretchedSpring Collection)
(isa StretchedSpring PhysicalModelFragmentType)
(mfTypeParticipant StretchedSpring ?spring Spring-Device springOf)
(mfTypeParticipantConstraint StretchedSpring (hasQuantity 
                                               ?spring (LengthFn ?spring)))
(mfTypeParticipantConstraint StretchedSpring (hasQuantity 
                                               ?spring (RestLengthFn ?spring)))
(mfTypeCondition StretchedSpring (qGreaterThan (LengthFn ?spring)
                                               (RestLengthFn ?spring)))


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; Rules
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; End of Code